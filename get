#!/usr/bin/env ruby
########################################################
require 'uri'
########################################################

def run(*cmd)
  puts
  # puts cmd.map { |c| c[" "] ? "'#{c}'" : c }.join(" ")
  system *cmd
  puts
end

def urlsnap(url)
  uri = URI.parse(url)
  outfile = uri.path.split("/").reject(&:empty?).last
  outfile = File.basename(outfile, ".*") + ".mhtml"

  cmd = ["urlsnap", "--mhtml=#{outfile}", url]

  puts "* Urlsnapping:"
  puts "  |_ input: #{url}"
  print "  |_ output: #{outfile}"
  run(*cmd)
  puts "* Done:"
  system("ls", "-l", outfile)
  puts
end

def curl(url)
  cmd = [
    "curl",
    "-L",       # follow redirects
    "--xattr",  # xattrs
    "-C", "-",  # resume at whatever the output file size is
    "-O",       # write to file named after remote name
    url
  ]

  run(*cmd)
end

########################################################

opts, args = ARGV.partition { |arg| arg[/^--?\w/] }

if opts.delete("--mhtml")
  getter = :urlsnap
else
  getter = :curl
end

args.each do |arg|
  send(getter, arg)
end
